(self.webpackChunkaerowork=self.webpackChunkaerowork||[]).push([[7728],{7728:function(t,e,n){"use strict";n.r(e),n.d(e,{TransactionPageModule:function(){return C}});var o=n(1116),a=n(1041),i=n(4812),r=n(4258),s=n(6570),c=n(752),l=n(3034),u=n(7767),d=n(8933),p=n(7686),g=n(3059),m=n(8153),h=n(7233),f=n(2977);function _(t,e){if(1&t&&(s.TgZ(0,"ion-select-option",16),s._uU(1),s.qZA()),2&t){var n=e.$implicit;s.s9C("value",n.plant_id),s.xp6(1),s.Oqu(n.tail_no)}}var v=[{path:"",component:function(){function t(t,e,n,o,i,r,s,c,l,u,d,p,g){var m=this;this.builder=t,this.loadingController=e,this.toastController=n,this.configurationService=o,this.plantService=i,this.tankService=r,this.transactionService=s,this.operatorService=c,this.timesheetService=l,this.bluetoothService=u,this.events=d,this.zone=p,this.geolocation=g,this.tanks=[],this.plants=[],this.operator={},this.transactionForm=t.group({driver_name:new a.NI("",a.kI.required),trailer_id:new a.NI(""),plant_id:new a.NI("",a.kI.required),start_value:new a.NI(""),end_value:new a.NI(""),transaction_end_date:new a.NI("")}),this.events.subscribe("plants:loaded",function(t){return m.populatePlants(t)}),this.populatePlants(null),this.configurationService.get("operator").then(function(t){console.log("[CreateTransactionPage] - constructor() :: operator:",t),m.operator=t,m.transactionForm.patchValue({driver_name:""+m.operator.first_name})}),this.configurationService.get("plant").then(function(t){console.log("[CreateTransactionPage] - constructor() :: plant_id:",t),m.transactionForm.patchValue({plant_id:t})}),this.onMeterData=function(t){m._onMeterData(t)},this.onMeterComplete=function(t){m._onMeterComplete()},this.onMeterListing=function(t){m.loader.setContent("Listing meters.")},this.onMeterListingSelect=function(t){m.loader.dismiss()},this.onMeterListingSelected=function(t){m.loader.present(),m.loader.setContent("Meter Selected.")},this.onMeterConnecting=function(t){m.loader.setContent("Connecting to meter.")},this.onMeterConnected=function(t){m.loader.setContent("Connected to meter.")},this.onMeterReading=function(t){m.loader.setContent("Reading data.")}}return t.prototype.ngOnInit=function(){},t.prototype.populatePlants=function(t){var e=this;console.log("[CreateTransactionPage] - populatePlants() :: Attempt to load plants from cache, with mode "+t),this.plantService.findAll().then(function(t){console.log("[CreateTransactionPage] - populatePlants() :: Found "+t.res.rows.length+" plants in cache."),e.plants=[];for(var n=0;n<t.res.rows.length;n++)e.plants.push({plant_id:t.res.rows.item(n).plant_id,tail_no:t.res.rows.item(n).tail_no});console.log("[CreateTransactionPage] - populatePlants() :: Plants found are "+e.plants)})},t.prototype.openSettings=function(t){console.log("[CreateTransactionPage] - openSettings()"),this.events.publish("settings:open",t)},t.prototype.readMeter=function(t){var e=this;console.log("[CreateTransactionPage] - readMeter() :: "),this.events.subscribe("meter:listing",function(t){e.onMeterListing(t)}),this.events.subscribe("meter:listingselect",function(t){e.onMeterListingSelect(t)}),this.events.subscribe("meter:connecting",function(t){e.onMeterConnecting(t)}),this.events.subscribe("meter:connected",function(t){e.onMeterConnected(t)}),this.events.subscribe("meter:reading",function(t){e.onMeterReading(t)}),this.events.subscribe("meter:complete",function(t){e.onMeterComplete(t)}),this.events.subscribe("meter:data",function(t){e.onMeterData(t.responses)}),this.loader=this.loadingController.create({message:"Contacting meter."}).then(function(t){e.loader=t,e.loader.present()}),this.bluetoothService.list()},t.prototype._onMeterComplete=function(){this.loader.dismiss()},t.prototype._onMeterData=function(t){var e=this;console.log("[CreateTransactionPage] - _onMeterData() :: ",t),this.events.unsubscribe("meter:data",function(t){e.onMeterData(t)}),this.events.unsubscribe("meter:listing",function(t){e.onMeterListing(t)}),this.events.unsubscribe("meter:connecting",function(t){e.onMeterConnecting(t)}),this.events.unsubscribe("meter:connected",function(t){e.onMeterConnected(t)}),this.events.unsubscribe("meter:reading",function(t){e.onMeterReading(t)});var n=t.pop();n?(this.zone.run(function(){e.transactionForm.patchValue({trailer_id:n.getData().meterID}),e.transactionForm.patchValue({start_value:n.getData().startVolume}),e.transactionForm.patchValue({end_value:n.getData().endVolume}),e.transactionForm.patchValue({transaction_end_date:n.getData().endDateTime})}),t.forEach(function(t){console.log("[CreateTransactionPage] - _onMeterData() :: Got BT data to upload in the background");var o={pad_id:"-1",operator_id:e.operator.operator_id,battery_percentage:"-1",long:-1,lat:-1,transaction_end_date:t.getData().endDateTime,end_total_value:t.getData().endVolume,end_value:t.getData().startVolume,plant_id:e.transactionForm.controls.plant_id.value,trailer_id:n.getData().meterID,odometer:"-1"};e.transactionService.create(o)}),this.onSubmit(this.transactionForm.value)):console.warn("[CreateTransactionPage] - _onMeterData() :: Received empty response, exiting.",n)},t.prototype.onSubmit=function(t){var e=this;console.log("[CreateTransactionPage] - onSubmit() :: Attempt to create transaction from data ",t),this.configurationService.set("plant",t.plant_id);var n=new Date,o=n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear()+" "+n.getHours()+":"+n.getMinutes()+":"+n.getSeconds(),a={pad_id:"-1",operator_id:this.operator.operator_id,battery_percentage:"-1",long:-1,lat:-1,transaction_end_date:t.transaction_end_date,end_total_value:t.end_value,end_value:t.start_value,plant_id:t.plant_id,trailer_id:t.trailer_id,odometer:"-1",local_timestamp:o};this.geolocation.getCurrentPosition({timeout:1e4}).then(function(n){console.log("[CreateTransactionPage] - onSubmit() :: Got geolocation data, creating transaction ",t),a.long=n.coords.longitude,a.lat=n.coords.latitude,e.createTransaction(a)},function(n){console.log("[CreateTransactionPage] - onSubmit() :: Failed to get geolocation ",t),e.createTransaction(a)}).catch(function(){e.createTransaction(a)})},t.prototype.getGPS=function(){this.geolocation.getCurrentPosition({timeout:1e4}).then(function(t){JSON.stringify(t),console.log(t)},function(t){console.log(t),JSON.stringify(t)}).catch(function(t){console.log(t)})},t.prototype.createTransaction=function(t){var e=this;this.transactionService.create(t).then(function(t){e.transactionForm.patchValue({start_value:null}),e.transactionForm.patchValue({end_value:null}),e.transactionForm.patchValue({trailer_id:null}),e.toastController.create({message:"Transaction saved!",duration:2e3}).then(function(t){t.present()})},function(t){e.toastController.create({message:"Error saving transaction!",duration:2e3,cssClass:"toast-error"}).then(function(t){t.present()})})},t.prototype.aircraftChanged=function(){this.toastController.create({message:"Aircraft Changed",duration:2e3}).then(function(t){t.present()})},t.\u0275fac=function(e){return new(e||t)(s.Y36(a.qu),s.Y36(i.HT),s.Y36(i.yF),s.Y36(c.e),s.Y36(l.L),s.Y36(u.A),s.Y36(d.p),s.Y36(p.p),s.Y36(g.r),s.Y36(m.G),s.Y36(h.z),s.Y36(s.R0b),s.Y36(f.b))},t.\u0275cmp=s.Xpm({type:t,selectors:[["app-transaction"]],decls:34,vars:3,consts:[["color","primary"],["slot","end"],["color","light",3,"click"],["name","settings"],["scroll","false",1,"ion-padding","form"],[3,"formGroup","ngSubmit"],["position","floating"],["type","text","formControlName","driver_name","readonly","true"],["formControlName","plant_id",3,"ionChange"],[3,"value",4,"ngFor","ngForOf"],["type","text","formControlName","trailer_id","readonly","true"],["position","fixed"],["type","text","formControlName","start_value","readonly","true"],["type","text","formControlName","end_value","readonly","true"],["type","hidden","formControlName","transaction_end_date","readonly","true",1,"hide-input"],["fill","outline","expand","block",3,"disabled","click"],[3,"value"]],template:function(t,e){1&t&&(s.TgZ(0,"ion-header"),s.TgZ(1,"ion-toolbar",0),s.TgZ(2,"ion-title"),s._uU(3,"Transactions"),s.qZA(),s.TgZ(4,"ion-buttons",1),s.TgZ(5,"ion-button",2),s.NdJ("click",function(t){return e.openSettings(t)}),s._UZ(6,"ion-icon",3),s.qZA(),s.qZA(),s.qZA(),s.qZA(),s.TgZ(7,"ion-content",4),s.TgZ(8,"ion-list"),s.TgZ(9,"form",5),s.NdJ("ngSubmit",function(){return e.onSubmit(e.transactionForm.value)}),s.TgZ(10,"ion-item"),s.TgZ(11,"ion-label",6),s._uU(12,"Operator"),s.qZA(),s._UZ(13,"ion-input",7),s.qZA(),s.TgZ(14,"ion-item"),s.TgZ(15,"ion-label",6),s._uU(16,"Aircraft number"),s.qZA(),s.TgZ(17,"ion-select",8),s.NdJ("ionChange",function(){return e.aircraftChanged()}),s.YNc(18,_,2,2,"ion-select-option",9),s.qZA(),s.qZA(),s.TgZ(19,"ion-item"),s.TgZ(20,"ion-label",6),s._uU(21,"Loader number"),s.qZA(),s._UZ(22,"ion-input",10),s.qZA(),s.TgZ(23,"ion-item"),s.TgZ(24,"ion-label",11),s._uU(25,"Start value"),s.qZA(),s._UZ(26,"ion-input",12),s.qZA(),s.TgZ(27,"ion-item"),s.TgZ(28,"ion-label",11),s._uU(29,"End value"),s.qZA(),s._UZ(30,"ion-input",13),s.qZA(),s._UZ(31,"ion-input",14),s.TgZ(32,"ion-button",15),s.NdJ("click",function(t){return e.readMeter(t)}),s._uU(33,"Fuelling Completed"),s.qZA(),s.qZA(),s.qZA(),s.qZA()),2&t&&(s.xp6(9),s.Q6J("formGroup",e.transactionForm),s.xp6(9),s.Q6J("ngForOf",e.plants),s.xp6(14),s.Q6J("disabled",!e.transactionForm.valid))},directives:[i.Gu,i.sr,i.wd,i.Sm,i.YG,i.gu,i.W2,i.q_,a._Y,a.JL,a.sg,i.Ie,i.Q$,i.pK,i.j9,a.JJ,a.u,i.t9,i.QI,o.sg,i.n0],styles:[".form[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{margin-top:20px}"]}),t}()}],b=function(){function t(){}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=s.oAB({type:t}),t.\u0275inj=s.cJS({imports:[[r.Bz.forChild(v)],r.Bz]}),t}(),C=function(){function t(){}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=s.oAB({type:t}),t.\u0275inj=s.cJS({imports:[[o.ez,a.u5,a.UX,i.Pc,b]]}),t}()}}]);